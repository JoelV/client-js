<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Request Examples</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css"/>
        <link rel="stylesheet" href="assets/prism.css"/>
        <style>
            html {
                scroll-behavior: smooth;
            }
            section {
                margin: 2em 0 3em;
            }
            .example {
                position: relative;
            }
            .example pre {
                padding: 6px 8px !important;
                margin: 1px 0 !important;
                line-height: 1.3 !important;
                font-size: 12px;
            }
            .example > button {
                padding: 6px 18px;
                position: absolute;
                top: 5px;
                right: 5px;
                font-weight: bold;
                font-family: Arial, Helvetica, sans-serif;
            }
            .result {
                overflow: auto;
                overflow: overlay;
                resize  : vertical;
            }
            .anchor {
                padding: 1em 5px 1em 10px;
                visibility: hidden;
                font-size: 16px;
                text-decoration: none;
                vertical-align: middle;
            }
            section h3:hover > .anchor {
                visibility: visible;
                text-decoration: none;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h2 class="page-header">
                <small class="pull-right">Run examples with: <select id="version-select">
                    <option value="latest-release">Latest NPM Release</option>
                    <option value="latest-build">Latest Development Build</option>
                </select></small>
                Client Examples</h2>

            <section>
                <h3>Fetch a resource</h3>
                <div class="example runnable">
<pre class="language-js">
const client = new FHIR.Client("https://r3.smarthealthit.org");
return client.request("Patient/2e27c71e-30c8-4ceb-8c1c-5641e066c0a4");
</pre>
                </div>
            </section>

            <section>
                <h3>Fetch a Bundle</h3>
                <div class="example runnable">
<pre class="language-js">
const client = new FHIR.Client("https://r4.smarthealthit.org");
return client.request("Patient");
</pre>
                </div>
            </section>

            <section>
                <h3>Display the current patient using the <code>client.patient</code> API</h3>
                <p>
                    Authenticated clients will have <code>patient.id</code>.
                    This example uses an open FHIR server so we pass a <code>patient</code>
                    to manually specify which the current patient is.
                </p>
                <div class="example runnable">
<pre class="language-js">
const client = new FHIR.Client({
    serverUrl: "https://r3.smarthealthit.org",
    tokenResponse: {
        patient: "2e27c71e-30c8-4ceb-8c1c-5641e066c0a4"
    }
});

return client.patient.read();
</pre>
                </div>
            </section>

            <section>
                <h3>Display the current patient using <code>client.request</code></h3>
                <p>
                    Authenticated clients will have <code>patient.id</code>.
                    This example uses an open FHIR server so we pass a <code>patient</code>
                    to manually specify which the current patient is.
                </p>
                <div class="example runnable">
<pre class="language-js">
const client = new FHIR.Client({
    serverUrl: "https://r3.smarthealthit.org",
    tokenResponse: {
        patient: "2e27c71e-30c8-4ceb-8c1c-5641e066c0a4"
    }
});

return client.request(`Patient/${client.patient.id}`);
</pre>
                </div>
            </section>

            <section>
                <h3>Display the current patient from EHR</h3>
                <div class="example">
<pre class="language-js">
// launch.html
FHIR.SMART.authorize({
    "client_id": "my-client-id",
    "scope": "launch"
});

// index.html
FHIR.SMART.ready(client => client.patient.read());
</pre>
                </div>
            </section>

            <section>
                <h3>Display the current user</h3>
                <p>
                    Properly launched and authenticated clients will have an <code>user</code> property.
                    To get that, you need to request <code>openid</code> and <code>fhirUser</code>
                    scopes. This example uses an open FHIR server so we pass an <code>id_token</code>
                    to manually specify which the current user is.
                </p>
                <div class="example runnable">
<pre class="language-js">
const id_token = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJwcm9maWxlIjoiUHJhY3RpdGlvbmVyL3NtYXJ0LVByYWN0aXRpb2" +
"5lci03MjA4MDQxNiIsImZoaXJVc2VyIjoiUHJhY3RpdGlvbmVyL3NtYXJ0LVByYWN0aXRpb25lci03MjA4MDQxNiIsInN1YiI6IjM2YTEwYm" +
"M0ZDJhNzM1OGI0YWZkYWFhZjlhZjMyYmFjY2FjYmFhYmQxMDkxYmQ0YTgwMjg0MmFkNWNhZGQxNzgiLCJpc3MiOiJodHRwOi8vbGF1bmNoLn" +
"NtYXJ0aGVhbHRoaXQub3JnIiwiaWF0IjoxNTU5MzkyMjk1LCJleHAiOjE1NTkzOTU4OTV9.niEs55G4AFJZtU_b9Y1Y6DQmXurUZZkh3WCud" +
"ZgwvYasxVU8x3gJiX3jqONttqPhkh7418EFssCKnnaBlUDwsbhp7xdWN4o1L1NvH4bp_R_zJ25F1s6jLmNm2Qp9LqU133PEdcRIqQPgBMyZB" +
"WUTyxQ9ihKY1RAjlztAULQ3wKea-rfe0BXJZeUJBsQPzYCnbKY1dON_NRd8N9pTImqf41MpIbEe7YEOHuirIb6HBpurhAHjTLDv1IuHpEAOx" +
"pmtxVVHiVf-FYXzTFmn4cGe2PsNJfBl8R_zow2n6qaSANdvSxJDE4DUgIJ6H18wiSJJHp6Plf_bapccAwxbx-zZCw";

const client = new FHIR.Client({
    serverUrl: "https://r3.smarthealthit.org",
    tokenResponse: { id_token }
});

// or client.request(client.user.fhirUser);
return client.user.read();
</pre>
                </div>
            </section>

            <section>
                <h3>Display the current user from EHR</h3>
                <p>
                    Properly launched and authenticated clients will have <code>userId</code>.
                    To get that, you need to request <code>openid</code> and <code>fhirUser</code>
                    scopes.
                </p>
                <div class="example">
<pre class="language-js">
// launch.html
FHIR.SMART.authorize({
    "client_id": "my-client-id",
    "scope": "openid fhirUser"
});

// index.html
FHIR.SMART.ready(client => client.user.read());
</pre>
                </div>
            </section>

            <section>
                <h3>Display patient medications</h3>
                <div class="example runnable">
<pre class="language-js">
const rxNorm  = "http://www.nlm.nih.gov/research/umls/rxnorm";
const client  = new FHIR.Client("https://r3.smarthealthit.org");

function getMedicationName(medCodings = []) {
    var coding = medCodings.find(c => c.system === rxNorm);
    return coding && coding.display || "Unnamed Medication(TM)";
}

return client.request("/MedicationRequest?patient=smart-1642068", {
    resolveReferences: "medicationReference"
}).then(data => data.entry.map(item => getMedicationName(
    FHIR.util.getPath(item, "resource.medicationCodeableConcept.coding") ||
    FHIR.util.getPath(item, "resource.medicationReference.code.coding")
)));
</pre>
                </div>
            </section>

            <section>
                <h3>Resolve references</h3>
                <p>
                    You can pass one or more reference paths as <code>resolveReferences</code>
                    option. The final result will contain the references replaced with resolved
                    resources.
                </p> 
                <div class="example runnable">
<pre class="language-js">
const client = new FHIR.Client("https://r3.smarthealthit.org");
return client.request("/Encounter/3d1ae6a9-b8c1-4c12-a8ba-b44d96ddfe24", {
    resolveReferences: ["serviceProvider", "subject"]
});
</pre>
                </div>
            </section>

            <section>
                <h3>Extract multiple related resources from single Observation</h3>
                <div class="example runnable">
<pre class="language-js">
const client = new FHIR.Client("https://r3.smarthealthit.org");

return client.request("Observation/smart-691-bmi", {
    resolveReferences: [
        "context",                 // The Encounter (STU-3)
        "context.serviceProvider", // The Organization (hospital, STU-3)
        "performer.0",             // The Practitioner (or use "performer" to get all practitioners)
        "subject",                 // The Patient
        "identifier..assigner"     // All identifier assigners
    ]
});
</pre>
                </div>
            </section>

            <section>
                <h3>Fetch references to external object</h3>
                <p>
                    In most cases having the resolved references mounted on the result structure
                    is very convenient. However, sometimes you might want to keep the original
                    response as is, or you may want to have a map of resolved references that can
                    be re-used later. To do so, you can use the same <code>resolveReferences</code>
                    option but combine it with <code>graph: false</code>. Then, the result will
                    contain two properties - <code>data</code> and <code>references</code>. Example:
                </p>
                <div class="example runnable">
<pre class="language-js">
const client = new FHIR.Client("https://r3.smarthealthit.org");
return client.request("/Encounter/3d1ae6a9-b8c1-4c12-a8ba-b44d96ddfe24", {
    resolveReferences: ["serviceProvider", "subject"],
    graph: false
});
</pre>
                </div>
            </section>
            
            <section>
                <h3>Get multiple pages</h3>
                <p>
                    This shows how to fetch 2 pages. Not that the result is an array of page bundles.
                </p>
                <div class="example runnable">
<pre class="language-js">
const client = new FHIR.Client("https://r3.smarthealthit.org");
return client.request("/Patient", { pageLimit: 2 });
</pre>
                </div>
            </section>
            
            <!-- =========================================================== -->
            <section>
                <h3>Get all pages</h3>
                <p>
                    To get all available pages use <code>pageLimit: 0</code>:
                </p>
                <div class="example runnable">
<pre class="language-js">
const client = new FHIR.Client("https://r4.smarthealthit.org");
return client.request("/Organization", { pageLimit: 0 });
</pre>
                </div>
            </section>

            <!-- =========================================================== -->
            <section>
                <h3>Process one page at a time</h3>
                <p>
                    Use <code>pageLimit: 0</code> to get all available pages and
                    <code>onPage</code> callback to handle each page as it arrives:
                </p>
                <div class="example runnable">
<pre class="language-js">
const client = new FHIR.Client("https://r4.smarthealthit.org");
let start = Date.now();

client.request("Organization", {
    pageLimit: 0,
    onPage(bundle) {
        const now = Date.now();
        log(`Got a bundle with ${bundle.entry.length} entires (took ${now - start} ms)`);
        start = now;
    }
});
</pre>
                </div>
            </section>

            <!-- =========================================================== -->
            <section>
                <h3>Validate a Resource</h3>
                <div class="example runnable">
<pre class="language-js">
const client = new FHIR.Client("https://r4.smarthealthit.org");
return client.request({
    url: "Observation/$validate?profile=http://hl7.org/fhir/StructureDefinition/heartrate",
    method: "POST",
    headers: {
        "content-type": "application/json"
    },
    body: JSON.stringify({
        resourceType: "Observation",
        unknownProperty: "This is a test!"
    })
}).catch(e => e.body)
</pre>
                </div>
            </section>

            <section>
                <h3>Building complex query strings</h3>
                <p>
                    Note that the browser will be polyfill-ed if needed and <code>URL</code> and
                    <code>URLSearchParams</code> will always be available in the global scope.
                </p>
                <div class="example runnable">
<pre class="language-js">
const client = new FHIR.Client("https://r2.smarthealthit.org");
const query  = new URLSearchParams();

query.set("patient", "smart-1482713");
query.set("_count", 50); // Try this to fetch fewer pages
query.set("code", [
    'http://loinc.org|29463-7', // weight
    'http://loinc.org|3141-9' , // weight
    'http://loinc.org|8302-2' , // Body height
    'http://loinc.org|8306-3' , // Body height --lying
    'http://loinc.org|8287-5' , // headC
    'http://loinc.org|39156-5', // BMI 39156-5
    'http://loinc.org|18185-9', // gestAge
    'http://loinc.org|37362-1', // bone age
    'http://loinc.org|11884-4'  // gestAge
].join(","));

return client.request("Observation?" + query, {
    pageLimit: 0, // get all pages
    flat: true    // return flat array of Observation resources
});
</pre>
                </div>
            </section>
        </div>
        <br/>
        <br/>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
        <script type="text/javascript" src="assets/prism.js"></script>
        <script>
        jQuery(function($) {

            function runCode(e) {
                const btn = $(e.target).closest("button");
                const div = btn.closest(".example");
                const result = div.find("pre.result");

                if (result.length) {
                    result.remove();
                    btn.text("Try Me ▶️");
                    return;
                }

                const code = div.find("> pre").text();
                const pre = $('<pre class="result language-json">Loading...</div>').appendTo(div);

                function log(str) {
                    pre[0].textContent += `${str}\n`;
                }

                (async function() {
                    
                    let x;
                    try {
                        x = await Function('log', code)(log)
                    } catch (ex) {
                        x = ex
                    }

                    if (x !== undefined) {
                        const isError = x instanceof Error;
                        const str = isError ? x.message : JSON.stringify(x, null, 4);
                    
                        pre.text(str);
                        if (pre.height() > 300) {
                            pre.css({ height: 300 })
                        }
                        if (!isError/* && str.length < 15000*/) {
                            Prism.highlightElement(pre[0], true);
                        }
                    } else {
                        pre.empty();
                    }
                    btn.text("Close Result ⏹️");
                })()
            }

            let ver = "latest-release"
            const match = location.search.match(/\bversion=(latest-release|latest-build)\b/);
            if (match && match[1]) {
                ver = match[1]
            }

            $.getScript(
                ver == "latest-release" ? 
                    "https://cdn.jsdelivr.net/npm/fhirclient@latest/build/fhir-client.min.js" :
                    "../dist/build/fhir-client.js"
            );

            $("#version-select").val(ver).on("change", function() {
                var query = new URLSearchParams(location.search);
                query.set("version", this.value);
                location.search = query.toString()
            })

            $("pre.language-js").each(function(i, el) {
                Prism.highlightElement(el);
            });

            $(".container section div.example.runnable").each((i, div) => {
                const btn = $('<button class="btn btn-default try-btn" type="button">Try Me ▶️</button>').on("click", runCode);
                $(div).append(btn);
            });

            $(".container section h3").each((i, h3) => {
                const text = h3.textContent;
                const slug = text.trim().replace(/\s+/g, "-").toLowerCase();
                $("<a>⚓</a>").attr({
                    name: slug,
                    href: "#" + slug,
                    class: "anchor"
                }).appendTo(h3)
            })
        });
        </script>
    </body>
</html>
