window.FHIR=function(e){var t={};function n(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(r,s,function(t){return e[t]}.bind(null,s));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=4)}([function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.assert=t.getTargetWindow=t.getPatientParam=t.getAccessTokenExpiration=t.jwtDecode=t.btoa=t.atob=t.isBrowser=t.randomString=t.absolute=t.setPath=t.getPath=t.fetchConformanceStatement=t.getAndCache=t.request=t.responseToJSON=t.checkResponse=t.units=t.debug=void 0;const r=n(6),s=n(1),o=n(7),{fetch:i}=window,a=o("FHIR");t.debug=a;const c={};function u({value:e,code:t}){if("number"!=typeof e)throw new Error("Found a non-numerical unit: "+e+" "+t)}async function l(e){if(!e.ok){const t=new r.default(e);throw await t.parse(),t}return e}function h(e){return e.text().then(e=>e.length?JSON.parse(e):"")}function f(e,t={}){const{includeResponse:n,...r}=t;return i(e,{mode:"cors",...r,headers:{accept:"application/json",...r.headers}}).then(l).then(e=>{const t=e.headers.get("Content-Type")+"";return t.match(/\bjson\b/i)?h(e).then(t=>({res:e,body:t})):t.match(/^text\//i)?e.text().then(t=>({res:e,body:t})):{res:e}}).then(({res:e,body:t})=>{if(!t&&201==e.status){const t=e.headers.get("location");if(t)return f(t,{...r,method:"GET",body:null,includeResponse:n})}return n?{body:t,response:e}:void 0===t?e:t})}function d(e,t,n=!1){return n||!c[e]?(c[e]=f(e,t),c[e]):Promise.resolve(c[e])}function p(e,t=""){if(!(t=t.trim()))return e;let n=t.split("."),r=e;for(;r&&n.length;){const e=n.shift();if(!e&&Array.isArray(r))return r.map(e=>p(e,n.join(".")));r=r[e]}return r}function g(){return"object"==typeof window}function m(t){return g()?window.atob(t):e.Buffer.from(t,"base64").toString("ascii")}function w(e){const t=e.split(".")[1];return t?JSON.parse(m(t)):null}t.units={cm({code:e,value:t}){if(u({code:e,value:t}),"cm"==e)return t;if("m"==e)return 100*t;if("in"==e)return 2.54*t;if("[in_us]"==e)return 2.54*t;if("[in_i]"==e)return 2.54*t;if("ft"==e)return 30.48*t;if("[ft_us]"==e)return 30.48*t;throw new Error("Unrecognized length unit: "+e)},kg({code:e,value:t}){if(u({code:e,value:t}),"kg"==e)return t;if("g"==e)return t/1e3;if(e.match(/lb/))return t/2.20462;if(e.match(/oz/))return t/35.274;throw new Error("Unrecognized weight unit: "+e)},any:e=>(u(e),e.value)},t.checkResponse=l,t.responseToJSON=h,t.request=f,t.getAndCache=d,t.fetchConformanceStatement=function(e="/",t){const n=String(e).replace(/\/*$/,"/")+"metadata";return d(n,t).catch(e=>{throw new Error(`Failed to fetch the conformance statement from "${n}". ${e}`)})},t.getPath=p,t.setPath=function(e,t,n,r=!1){return t.trim().split(".").reduce((e,t,s,o)=>{if(!e||s!==o.length-1)return e&&void 0===e[t]&&r&&(e[t]=o[s+1].match(/^[0-9]+$/)?[]:{}),e?e[t]:void 0;e[t]=n},e),e},t.absolute=function(e,t){return e.match(/^http/)||e.match(/^urn/)?e:String(t||"").replace(/\/+$/,"")+"/"+e.replace(/^\/+/,"")},t.randomString=function(e=8,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"){const n=[],r=t.length;for(;e--;)n.push(t.charAt(Math.floor(Math.random()*r)));return n.join("")},t.isBrowser=g,t.atob=m,t.btoa=function(t){return g()?window.btoa(t):e.Buffer.from(t).toString("base64")},t.jwtDecode=w,t.getAccessTokenExpiration=function(e){const t=Math.floor(Date.now()/1e3);if(e.expires_in)return t+e.expires_in;if(e.access_token){let t=w(e.access_token);if(t&&t.exp)return t.exp}return t+300},t.getPatientParam=function(e,t){const n=(p(e,"rest.0.resource")||[]).find(e=>e.type===t);if(!n)throw new Error(`Resource "${t}" is not supported by this FHIR server`);if(!Array.isArray(n.searchParam))throw new Error(`No search parameters supported for "${t}" on this FHIR server`);if("Patient"==t&&n.searchParam.find(e=>"_id"==e.name))return"_id";const r=s.patientParams.find(e=>n.searchParam.find(t=>t.name==e));if(!r)throw new Error("I don't know what param to use for "+t);return r},t.getTargetWindow=async function(e,t=800,n=720){if("function"==typeof e&&(e=await e()),e&&"object"==typeof e)return e;if("string"!=typeof e)return a("Invalid target type '%s'. Failing back to '_self'.",typeof e),self;if("_self"==e)return self;if("_parent"==e)return parent;if("_top"==e)return top;if("_blank"==e){let e,t=null;try{if(t=window.open("","SMARTAuthPopup"),!t)throw new Error("Perhaps window.open was blocked")}catch(t){e=t}return t||(a("Cannot open window. Failing back to '_self'. %s",e),self)}if("popup"==e){let e,r=null;try{if(r=window.open("","SMARTAuthPopup",["height="+n,"width="+t,"menubar=0","resizable=1","status=0","top="+(screen.height-n)/2,"left="+(screen.width-t)/2].join(",")),!r)throw new Error("Perhaps the popup window was blocked")}catch(t){e=t}return r||(a("Cannot open window. Failing back to '_self'. %s",e),self)}const r=frames[e];return r||(a("Unknown target '%s'. Failing back to '_self'.",e),self)},t.assert=function(e,t){if(!e)throw new Error(t)}}).call(this,n(5))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SMART_KEY=t.patientParams=t.fhirVersions=t.patientCompartment=void 0,t.patientCompartment=["Account","AdverseEvent","AllergyIntolerance","Appointment","AppointmentResponse","AuditEvent","Basic","BodySite","BodyStructure","CarePlan","CareTeam","ChargeItem","Claim","ClaimResponse","ClinicalImpression","Communication","CommunicationRequest","Composition","Condition","Consent","Coverage","CoverageEligibilityRequest","CoverageEligibilityResponse","DetectedIssue","DeviceRequest","DeviceUseRequest","DeviceUseStatement","DiagnosticOrder","DiagnosticReport","DocumentManifest","DocumentReference","EligibilityRequest","Encounter","EnrollmentRequest","EpisodeOfCare","ExplanationOfBenefit","FamilyMemberHistory","Flag","Goal","Group","ImagingManifest","ImagingObjectSelection","ImagingStudy","Immunization","ImmunizationEvaluation","ImmunizationRecommendation","Invoice","List","MeasureReport","Media","MedicationAdministration","MedicationDispense","MedicationOrder","MedicationRequest","MedicationStatement","MolecularSequence","NutritionOrder","Observation","Order","Patient","Person","Procedure","ProcedureRequest","Provenance","QuestionnaireResponse","ReferralRequest","RelatedPerson","RequestGroup","ResearchSubject","RiskAssessment","Schedule","ServiceRequest","Specimen","SupplyDelivery","SupplyRequest","VisionPrescription"],t.fhirVersions={"0.4.0":2,"0.5.0":2,"1.0.0":2,"1.0.1":2,"1.0.2":2,"1.1.0":3,"1.4.0":3,"1.6.0":3,"1.8.0":3,"3.0.0":3,"3.0.1":3,"3.3.0":4,"3.5.0":4,"4.0.0":4,"4.0.1":4},t.patientParams=["patient","subject","requester","member","actor","beneficiary"],t.SMART_KEY="SMART_KEY"},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Client=t.msg=void 0;const r=n(0),s=n(3),o=n(1),{Response:i}=window,a=r.debug.extend("client");function c(e,t,n,o,i,a){const c=r.getPath(e,t);if(c){const u=Array.isArray(c);return Promise.all(s.makeArray(c).filter(Boolean).map((s,c)=>{const l=s.reference;if(l)return function(e,t,n,r){return t[e]||(t[e]=n.request({url:e,signal:r}).then(n=>(t[e]=n,n),n=>{throw delete t[e],n})),Promise.resolve(t[e])}(l,o,i,a).then(s=>{n&&(u?t.indexOf("..")>-1?r.setPath(e,""+t.replace("..",`.${c}.`),s):r.setPath(e,`${t}.${c}`,s):r.setPath(e,t,s))}).catch(e=>{if(404!==e.status)throw e})}))}}function u(e,t,n,r,o){let i=s.makeArray(t.resolveReferences).filter(Boolean).map(e=>String(e).trim()).filter(Boolean);if(i=i.filter((e,t)=>!(i.indexOf(e,t+1)>-1)||(a('Duplicated reference path "%s"',e),!1)),!i.length)return Promise.resolve();const u={};i.forEach(e=>{const t=e.split(".").length;u[t]||(u[t]=[]),u[t].push(e)});let l=Promise.resolve();return Object.keys(u).sort().forEach(s=>{const i=u[s];l=l.then(()=>Promise.all(i.map(s=>c(e,s,!!t.graph,n,r,o))))}),l}t.msg={noPatientBeforeAuth:"Cannot get the ID of the selected patient before the app is authorized",noPatientFromOpenServer:"Cannot get the ID of the selected patient from an open FHIR server",noPatientScopes:"Unable to get the ID of the selected patient. Insufficient scopes. 'launch' or 'launch/patient' scope is needed.",noPatientAvailable:"The ID of the selected patient is not available. Please check if the server supports that.",noEncounterBeforeAuth:"Cannot get the ID of the selected encounter before the app is authorized",noEncounterFromOpenServer:"Cannot get the ID of the selected encounter from an open FHIR server",noEncounterScopes:"Unable to get the ID of the selected encounter. Insufficient scopes. 'launch' or 'launch/encounter' scope is needed.",noEncounterAvailable:"The ID of the selected encounter is not available. Check if this server supports encounter context, and if the selected patient has any recorded encounters.",noUserBeforeAuth:"Cannot get the current user before the app is authorized",noUserFromOpenServer:"Cannot get the current user from an open FHIR server",noUserScopes:"Unable to get the current user. Insufficient scopes. 'openid fhirUser' or 'openid profile' scopes are needed.",noUserAvailable:"The current user is not available. Check if this server supports id tokens.",requestNeedsArgs:"request requires an url or request options as argument",appRequiresSMART:"This app cannot be accessed directly. Please launch it as SMART app!",sessionExpiredAndNoRefresh:"Your session has expired and the useRefreshToken option is set to false. Please re-launch the app.",sessionExpired:"Session expired! Please re-launch the app.",autoRefreshFailed:"Auto-refresh failed! Please re-launch the app.",requestGot403:"Permission denied! Please make sure that you have requested the proper scopes.",cantRefreshNoToken:"Unable to refresh. No refresh_token found.",cantRefreshNoTokenUri:"Unable to refresh. No tokenUri found.",cantRefreshNoScopes:"Unable to refresh. No offline_access or online_access scope found.",gotNoAccessToken:"No access token received",rejectedScopes:'The following scopes were requested but not granted by the auth server: "%s"',noExpiresAt:"Auto-refresh might fail! The client got an access token but can't reliably determine when it will expire. The client does not know when that access token was issued. Please also provide an 'expiresAt' state parameter."};t.Client=class{constructor(e,n={}){this.options={refreshWithCredentials:"same-origin"},this._refreshTask=null,this.units=r.units,"string"==typeof e&&(e={serverUrl:e}),r.assert(e.serverUrl&&e.serverUrl.match(/https?:\/\/.+/),'A "serverUrl" option is required and must begin with "http(s)"'),Object.assign(this.options,n),this.state=e;const s=this;this.patient={get id(){return s.getPatientId()},read:e=>{const t=this.patient.id;return t?this.request({...e,url:"Patient/"+t}):Promise.reject(new Error("Patient is not available"))},request:(e,t={})=>this.patient.id?(async()=>{const n=await async function(e,t){const n=r.absolute("/",t.state.serverUrl);async function s(e){const n=e.pathname.split("/").pop();r.assert(n,`Invalid url "${e}"`),r.assert(o.patientCompartment.indexOf(n)>-1,`Cannot filter "${n}" resources by patient`);const s=await r.fetchConformanceStatement(t.state.serverUrl),i=r.getPatientParam(s,n);return e.searchParams.set(i,t.patient.id),e.href}return"string"==typeof e||e instanceof URL?{url:await s(new URL(e+"",n))}:(e.url=await s(new URL(e.url+"",n)),e)}(e,this);return this.request(n,t)})():Promise.reject(new Error("Patient is not available"))},this.encounter={get id(){return s.getEncounterId()},read:e=>{const t=this.encounter.id;return t?this.request({...e,url:"Encounter/"+t}):Promise.reject(new Error("Encounter is not available"))}},this.user={get fhirUser(){return s.getFhirUser()},get id(){return s.getUserId()},get resourceType(){return s.getUserType()},read:e=>{const t=this.user.fhirUser;return t?this.request({...e,url:t}):Promise.reject(new Error("User is not available"))}},r.isBrowser()&&this.connect(window.fhir),this.checkScopes(),!this.state.expiresAt&&this.state.tokenUri&&this.state.tokenResponse&&this.state.tokenResponse.access_token&&this.state.tokenResponse.refresh_token&&(this.hasGrantedScope("offline_access")||this.hasGrantedScope("online_access"))&&console.warn(t.msg.noExpiresAt)}connect(e){if("function"==typeof e){const t={baseUrl:this.state.serverUrl.replace(/\/$/,"")},n=this.getState("tokenResponse.access_token");if(n)t.auth={token:n};else{const{username:e,password:n}=this.state;e&&n&&(t.auth={user:e,pass:n})}this.api=e(t);const r=this.getState("tokenResponse.patient");r&&(this.patient.api=e({...t,patient:r}))}return this}hasGrantedScope(e){var t;return String((null===(t=this.state.tokenResponse)||void 0===t?void 0:t.scope)||"").trim().split(/\s+/).indexOf(e)>-1}checkScopes(){var e;const n=String(this.state.scope||"").trim().split(/\s+/).filter(Boolean),r=String((null===(e=this.state.tokenResponse)||void 0===e?void 0:e.scope)||"").trim().split(/\s+/),s=[];for(const e of n)-1===r.indexOf(e)&&s.push(e);s.length&&console.warn(t.msg.rejectedScopes,s.join('", "'))}getPatientId(){const e=this.state.tokenResponse;if(e){if(e.patient)return e.patient;console.warn(this.hasGrantedScope("launch")||this.hasGrantedScope("launch/patient")?t.msg.noPatientAvailable:t.msg.noPatientScopes)}else console.warn(this.state.authorizeUri?t.msg.noPatientBeforeAuth:t.msg.noPatientFromOpenServer);return null}getEncounterId(){const e=this.state.tokenResponse;if(e){if(e.encounter)return e.encounter;console.warn(this.hasGrantedScope("launch")||this.hasGrantedScope("launch/encounter")?t.msg.noEncounterAvailable:t.msg.noEncounterScopes)}else console.warn(this.state.authorizeUri?t.msg.noEncounterBeforeAuth:t.msg.noEncounterFromOpenServer);return null}getIdToken(){const e=this.state.tokenResponse;if(e){const n=e.id_token;if(!n){const e=this.hasGrantedScope("openid"),n=this.hasGrantedScope("profile"),r=this.hasGrantedScope("fhirUser");return console.warn(e&&(r||n)?t.msg.noUserAvailable:t.msg.noUserScopes),null}return r.jwtDecode(n)}return console.warn(this.state.authorizeUri?t.msg.noUserBeforeAuth:t.msg.noUserFromOpenServer),null}getFhirUser(){const e=this.getIdToken();return e?e.fhirUser?e.fhirUser.split("/").slice(-2).join("/"):e.profile:null}getUserId(){const e=this.getFhirUser();return e?e.split("/")[1]:null}getUserType(){const e=this.getFhirUser();return e?e.split("/")[0]:null}getAuthorizationHeader(){const e=this.getState("tokenResponse.access_token");if(e)return"Bearer "+e;const{username:t,password:n}=this.state;return t&&n?"Basic "+r.btoa(t+":"+n):null}async saveState(){this.options.save&&await this.options.save(this.state)}create(e,t){return this.request({...t,url:""+e.resourceType,method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json",...(t||{}).headers}})}update(e,t){return this.request({...t,url:`${e.resourceType}/${e.id}`,method:"PUT",body:JSON.stringify(e),headers:{"Content-Type":"application/json",...(t||{}).headers}})}delete(e,t={}){return this.request({...t,url:e,method:"DELETE"})}async request(e,n={},o={}){var a;const c=r.debug.extend("client:request");let l;r.assert(e,t.msg.requestNeedsArgs),"string"==typeof e||e instanceof URL?(l=String(e),e={}):l=String(e.url),l=r.absolute(l,this.state.serverUrl);const h={graph:!1!==n.graph,flat:!!n.flat,pageLimit:null!==(a=n.pageLimit)&&void 0!==a?a:1,resolveReferences:n.resolveReferences||[],useRefreshToken:!1!==n.useRefreshToken,onPage:"function"==typeof n.onPage?n.onPage:void 0},f=e.signal||void 0;let d;return(h.useRefreshToken?this.refreshIfNeeded({signal:f}).then(()=>e):Promise.resolve(e)).then(e=>{const t=this.getAuthorizationHeader();return t&&(e.headers={...e.headers,Authorization:t}),e}).then(e=>(c("%s, options: %O, fhirOptions: %O",l,e,h),r.request(l,e).then(t=>e.includeResponse?(d=t.response,t.body):t))).catch(async e=>{if(401==e.status){if(!this.getState("tokenResponse.access_token"))throw e.message+="\n"+t.msg.appRequiresSMART,e;if(!h.useRefreshToken)throw c(t.msg.sessionExpiredAndNoRefresh),this.state.tokenResponse={},await this.saveState(),e.message+="\n"+t.msg.sessionExpired,e;throw c(t.msg.autoRefreshFailed),this.state.tokenResponse={},await this.saveState(),e.message+="\n"+t.msg.sessionExpired,e}throw e}).catch(e=>{throw 403==e.status&&c(t.msg.requestGot403),e}).then(t=>t?"string"==typeof t||t instanceof i?t:(async e=>("Bundle"==e.resourceType?await Promise.all((e.entry||[]).map(e=>u(e.resource,h,o,this,f))):await u(e,h,o,this,f),e))(t).then(async e=>{if(e&&"Bundle"==e.resourceType){const t=e.link||[];if(h.flat&&(e=(e.entry||[]).map(e=>e.resource)),h.onPage&&await h.onPage(e,{...o}),--h.pageLimit){const n=t.find(e=>"next"==e.relation);if(e=s.makeArray(e),n&&n.url){const t=await this.request({url:n.url,signal:f},h,o);return h.onPage?null:h.resolveReferences.length?(Object.assign(o,t.references),e.concat(s.makeArray(t.data||t))):e.concat(s.makeArray(t))}}}return e}).then(e=>{if(h.graph)o={};else if(!h.onPage&&h.resolveReferences.length)return{data:e,references:o};return e}).then(t=>e.includeResponse?{body:t,response:d}:t):t)}refreshIfNeeded(e={}){const t=this.getState("tokenResponse.access_token"),n=this.getState("tokenResponse.refresh_token"),r=this.state.expiresAt||0;return t&&n&&r-10<Date.now()/1e3?this.refresh(e):Promise.resolve(this.state)}refresh(e={}){var n,s;const o=r.debug.extend("client:refresh");o("Attempting to refresh with refresh_token...");const i=null===(s=null===(n=this.state)||void 0===n?void 0:n.tokenResponse)||void 0===s?void 0:s.refresh_token;if(!i)return Promise.reject(new Error(t.msg.cantRefreshNoToken));const a=this.state.tokenUri;if(!a)return Promise.reject(new Error(t.msg.cantRefreshNoTokenUri));const c=this.hasGrantedScope("offline_access"),u=this.hasGrantedScope("online_access");if(!c&&!u)return Promise.reject(new Error(t.msg.cantRefreshNoScopes));const l={credentials:this.options.refreshWithCredentials,...e,method:"POST",mode:"cors",headers:{...e.headers||{},"content-type":"application/x-www-form-urlencoded"},body:"grant_type=refresh_token&refresh_token="+encodeURIComponent(i)};if(!("authorization"in l.headers)){const{clientSecret:e,clientId:t}=this.state;e&&(l.headers.authorization="Basic "+r.btoa(t+":"+e))}return this._refreshTask||(this._refreshTask=r.request(a,l).then(e=>(r.assert(e.access_token,t.msg.gotNoAccessToken),o("Received new access token response %O",e),Object.assign(this.state.tokenResponse,e),this.state.expiresAt=r.getAccessTokenExpiration(e),this.checkScopes(),this.state)).catch(e=>{var t,n;throw(null===(n=null===(t=this.state)||void 0===t?void 0:t.tokenResponse)||void 0===n?void 0:n.refresh_token)&&(o("Deleting the expired or invalid refresh token."),delete this.state.tokenResponse.refresh_token),e}).finally(()=>(this._refreshTask=null,this.saveState().catch(e=>o(e.message)).then(()=>this.state)))),this._refreshTask}byCode(e,t){return s.byCode(e,t)}byCodes(e,t){return s.byCodes(e,t)}getPath(e,t=""){return r.getPath(e,t)}getState(e=""){return r.getPath({...this.state},e)}getFhirVersion(){return r.fetchConformanceStatement(this.state.serverUrl).then(e=>e.fhirVersion)}getFhirRelease(){return this.getFhirVersion().then(e=>o.fhirVersions[e]||0)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.makeArray=t.byCodes=t.byCode=void 0;var r=n(0);function s(e,t){const n={};function r(e,t){e&&Array.isArray(e.coding)&&e.coding.forEach(({code:e})=>{e&&(n[e]=n[e]||[],n[e].push(t))})}return o(e).forEach(e=>{"Observation"===e.resourceType&&e[t]&&(Array.isArray(e[t])?e[t].forEach(t=>r(t,e)):r(e[t],e))}),n}function o(e){return Array.isArray(e)?e:[e]}Object.defineProperty(t,"getPath",{enumerable:!0,get:function(){return r.getPath}}),Object.defineProperty(t,"setPath",{enumerable:!0,get:function(){return r.setPath}}),t.byCode=s,t.byCodes=function(e,t){const n=s(e,t);return(...e)=>e.filter(e=>e+""in n).reduce((e,t)=>e.concat(n[t+""]),[])},t.makeArray=o},function(e,t,n){"use strict";const r=n(2),s=n(3),o=n(11),i=new(n(12).default);const a={Client:r.Client,SMART:{authorize:e=>o.authorize(i,e),ready:(e,t)=>o.ready(i,e,t),init:e=>o.init(i,e)},util:s};e.exports=a},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class r extends Error{constructor(e){super(`${e.status} ${e.statusText}\nURL: ${e.url}`),this.name="HttpError",this.response=e,this.statusCode=e.status,this.status=e.status,this.statusText=e.statusText}async parse(){if(!this.response.bodyUsed)try{const e=this.response.headers.get("Content-Type")||"text/plain";e.match(/\bjson\b/i)?(this.body=await this.response.json(),this.body.error?(this.message+="\n"+this.body.error,this.body.error_description&&(this.message+=": "+this.body.error_description)):this.message+="\n\n"+JSON.stringify(this.body,null,4)):e.match(/^text\//i)&&(this.body=await this.response.text(),this.body&&(this.message+="\n\n"+this.body))}catch{}return this}toJSON(){return{name:this.name,statusCode:this.statusCode,status:this.status,statusText:this.statusText,message:this.message}}}t.default=r},function(e,t,n){(function(r){t.log=function(...e){return"object"==typeof console&&console.log&&console.log(...e)},t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const n="color: "+this.color;t.splice(1,0,n,"color: inherit");let r=0,s=0;t[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(r++,"%c"===e&&(s=r))}),t.splice(s,0,n)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}!e&&void 0!==r&&"env"in r&&(e=r.env.DEBUG);return e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],e.exports=n(9)(t);const{formatters:s}=e.exports;s.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}).call(this,n(8))},function(e,t){var n,r,s=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function a(e){if(n===setTimeout)return setTimeout(e,0);if((n===o||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:o}catch(e){n=o}try{r="function"==typeof clearTimeout?clearTimeout:i}catch(e){r=i}}();var c,u=[],l=!1,h=-1;function f(){l&&c&&(l=!1,c.length?u=c.concat(u):h=-1,u.length&&d())}function d(){if(!l){var e=a(f);l=!0;for(var t=u.length;t;){for(c=u,u=[];++h<t;)c&&c[h].run();h=-1,t=u.length}c=null,l=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===i||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function p(e,t){this.fun=e,this.array=t}function g(){}s.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];u.push(new p(e,t)),1!==u.length||l||a(d)},p.prototype.run=function(){this.fun.apply(null,this.array)},s.title="browser",s.browser=!0,s.env={},s.argv=[],s.version="",s.versions={},s.on=g,s.addListener=g,s.once=g,s.off=g,s.removeListener=g,s.removeAllListeners=g,s.emit=g,s.prependListener=g,s.prependOnceListener=g,s.listeners=function(e){return[]},s.binding=function(e){throw new Error("process.binding is not supported")},s.cwd=function(){return"/"},s.chdir=function(e){throw new Error("process.chdir is not supported")},s.umask=function(){return 0}},function(e,t,n){e.exports=function(e){function t(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return r.colors[Math.abs(t)%r.colors.length]}function r(e){let n;function i(...e){if(!i.enabled)return;const t=i,s=Number(new Date),o=s-(n||s);t.diff=o,t.prev=n,t.curr=s,n=s,e[0]=r.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let a=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,(n,s)=>{if("%%"===n)return n;a++;const o=r.formatters[s];if("function"==typeof o){const r=e[a];n=o.call(t,r),e.splice(a,1),a--}return n}),r.formatArgs.call(t,e);(t.log||r.log).apply(t,e)}return i.namespace=e,i.enabled=r.enabled(e),i.useColors=r.useColors(),i.color=t(e),i.destroy=s,i.extend=o,"function"==typeof r.init&&r.init(i),r.instances.push(i),i}function s(){const e=r.instances.indexOf(this);return-1!==e&&(r.instances.splice(e,1),!0)}function o(e,t){const n=r(this.namespace+(void 0===t?":":t)+e);return n.log=this.log,n}function i(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return r.debug=r,r.default=r,r.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},r.disable=function(){const e=[...r.names.map(i),...r.skips.map(i).map(e=>"-"+e)].join(",");return r.enable(""),e},r.enable=function(e){let t;r.save(e),r.names=[],r.skips=[];const n=("string"==typeof e?e:"").split(/[\s,]+/),s=n.length;for(t=0;t<s;t++)n[t]&&("-"===(e=n[t].replace(/\*/g,".*?"))[0]?r.skips.push(new RegExp("^"+e.substr(1)+"$")):r.names.push(new RegExp("^"+e+"$")));for(t=0;t<r.instances.length;t++){const e=r.instances[t];e.enabled=r.enabled(e.namespace)}},r.enabled=function(e){if("*"===e[e.length-1])return!0;let t,n;for(t=0,n=r.skips.length;t<n;t++)if(r.skips[t].test(e))return!1;for(t=0,n=r.names.length;t<n;t++)if(r.names[t].test(e))return!0;return!1},r.humanize=n(10),Object.keys(e).forEach(t=>{r[t]=e[t]}),r.instances=[],r.names=[],r.skips=[],r.formatters={},r.selectColor=t,r.enable(r.load()),r}},function(e,t){var n=1e3,r=6e4,s=60*r,o=24*s;function i(e,t,n,r){var s=t>=1.5*n;return Math.round(e/n)+" "+r+(s?"s":"")}e.exports=function(e,t){t=t||{};var a=typeof e;if("string"===a&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^((?:\d+)?\-?\d?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!t)return;var i=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*i;case"weeks":case"week":case"w":return 6048e5*i;case"days":case"day":case"d":return i*o;case"hours":case"hour":case"hrs":case"hr":case"h":return i*s;case"minutes":case"minute":case"mins":case"min":case"m":return i*r;case"seconds":case"second":case"secs":case"sec":case"s":return i*n;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return i;default:return}}(e);if("number"===a&&!1===isNaN(e))return t.long?function(e){var t=Math.abs(e);if(t>=o)return i(e,t,o,"day");if(t>=s)return i(e,t,s,"hour");if(t>=r)return i(e,t,r,"minute");if(t>=n)return i(e,t,n,"second");return e+" ms"}(e):function(e){var t=Math.abs(e);if(t>=o)return Math.round(e/o)+"d";if(t>=s)return Math.round(e/s)+"h";if(t>=r)return Math.round(e/r)+"m";if(t>=n)return Math.round(e/n)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.init=t.ready=t.getClient=t.buildTokenRequest=t.completeAuth=t.onMessage=t.isInPopUp=t.isInFrame=t.authorize=t.getSecurityExtensions=t.fetchWellKnownJson=t.KEY=void 0;const r=n(0),s=n(2),o=n(1);Object.defineProperty(t,"KEY",{enumerable:!0,get:function(){return o.SMART_KEY}});const i=r.debug.extend("oauth2");function a(e="/",t){const n=String(e).replace(/\/*$/,"/")+".well-known/smart-configuration";return r.getAndCache(n,t).catch(e=>{throw new Error(`Failed to fetch the well-known json "${n}". ${e.message}`)})}function c(e="/",t){return a(e,t).then(e=>(r.assert(e.authorization_endpoint&&e.token_endpoint,"Invalid wellKnownJson"),{registrationUri:e.registration_endpoint||"",authorizeUri:e.authorization_endpoint,tokenUri:e.token_endpoint}))}function u(e="/",t){return r.fetchConformanceStatement(e,t).then(e=>{const t=(r.getPath(e||{},"rest.0.security.extension")||[]).filter(e=>"http://fhir-registry.smarthealthit.org/StructureDefinition/oauth-uris"===e.url).map(e=>e.extension)[0],n={registrationUri:"",authorizeUri:"",tokenUri:""};return t&&t.forEach(e=>{"register"===e.url&&(n.registrationUri=e.valueUri),"authorize"===e.url&&(n.authorizeUri=e.valueUri),"token"===e.url&&(n.tokenUri=e.valueUri)}),n})}function l(e){const t=e.length,n=[];let r=!1;return new Promise((s,o)=>{function i(e){n.push(e)===t&&o(new Error(n.map(e=>e.message).join("; ")))}e.forEach(t=>{t.promise.then(n=>function(t,n){t.complete=!0,r||(r=!0,e.forEach(e=>{e.complete||e.controller.abort()}),s(n))}(t,n),i)})})}function h(e,t="/"){const n=e.getAbortController(),r=new n,s=new n;return l([{controller:r,promise:c(t,{signal:r.signal})},{controller:s,promise:u(t,{signal:s.signal})}])}async function f(e,t={}){const n=e.getUrl();if(Array.isArray(t)){const s=n.searchParams.get("iss")||n.searchParams.get("fhirServiceUrl");r.assert(s,'Passing in an "iss" url parameter is required if authorize uses multiple configurations');const o=t.find(e=>{if(e.issMatch){if("function"==typeof e.issMatch)return!!e.issMatch(s);if("string"==typeof e.issMatch)return e.issMatch===s;if(e.issMatch instanceof RegExp)return e.issMatch.test(s)}return!1});return r.assert(o,`No configuration found matching the current "iss" parameter "${s}"`),await f(e,o)}const{clientSecret:s,fakeTokenResponse:a,patientId:c,encounterId:u,noRedirect:l,target:m,width:w,height:y,multiple:C}=t;let{iss:b,launch:v,fhirServiceUrl:k,redirectUri:S,scope:R="",clientId:P,completeInTarget:U}=t;const A=e.getStorage();b=n.searchParams.get("iss")||b,k=n.searchParams.get("fhirServiceUrl")||k,v=n.searchParams.get("launch")||v,S?S.match(/^https?\:\/\//)||(S=e.relative(S)):S=e.relative(".");const F=String(b||k||"");if(r.assert(F,'No server url found. It must be specified as "iss" or as "fhirServiceUrl" parameter'),b&&i("Making %s launch...",v?"EHR":"standalone"),v&&!R.match(/launch/)&&(R=R?R+" launch":"launch"),r.isBrowser()){const e=d(),t=p();(e||t)&&!0!==U&&!1!==U&&(U=e,console.warn('Your app is being authorized from within an iframe or popup window. Please be explicit and provide a "completeInTarget" option. Use "true" to complete the authorization in the same window, or "false" to try to complete it in the parent or the opener window. See http://docs.smarthealthit.org/client-js/api.html'))}const T=r.randomString(16),_={clientId:P,scope:R,redirectUri:S,serverUrl:F,clientSecret:s,tokenResponse:{},multiple:C,completeInTarget:U};C||await A.set(o.SMART_KEY,T),a&&Object.assign(_.tokenResponse,a),c&&Object.assign(_.tokenResponse,{patient:c}),u&&Object.assign(_.tokenResponse,{encounter:u});let E=S+"?state="+encodeURIComponent(T);if(k&&!b)return console.log("Making fake launch..."),await A.set(T,_),l?E:await e.redirect(E);const x=await h(e,F);if(Object.assign(_,x),await A.set(T,_),!_.authorizeUri)return l?E:await e.redirect(E);const I=["response_type=code","client_id="+encodeURIComponent(P||""),"scope="+encodeURIComponent(R),"redirect_uri="+encodeURIComponent(S),"aud="+encodeURIComponent(F),"state="+encodeURIComponent(T)];if(v&&I.push("launch="+encodeURIComponent(v)),E=_.authorizeUri+"?"+I.join("&"),l)return E;if(!m||!r.isBrowser())return await e.redirect(E);{let e;if(e=await r.getTargetWindow(m,w,y),e!==self)try{e.sessionStorage.setItem(T,JSON.stringify(_))}catch(t){r.debug('Failed to modify window.sessionStorage. Perhaps it is from different origin?. Failing back to "_self". %s',t),e=self}if(e!==self)try{e.location.href=E,self.addEventListener("message",g)}catch(e){r.debug('Failed to modify window.location. Perhaps it is from different origin?. Failing back to "_self". %s',e),self.location.href=E}else self.location.href=E}}function d(){try{return self!==top&&parent!==self}catch(e){return!0}}function p(){try{return self===top&&!!opener&&opener!==self&&!!window.name}catch(e){return!1}}function g(e){"completeAuth"==e.data.type&&e.origin===new URL(self.location.href).origin&&(window.removeEventListener("message",g),window.location.href=e.data.url)}async function m(e){var t,n;const s=e.getUrl(),a=e.getStorage(),c=s.searchParams,u=c.get("code"),l=c.get("error"),h=c.get("error_description"),f=c.get("state");r.assert(!(l||h),[l,h].filter(Boolean).join(": ")),i("key: %s, code: %s",f,u),r.assert(f,"No 'state' parameter found. Please launch this as SMART app.");let g=await a.get(f);if(r.isBrowser()&&g&&!g.completeInTarget){const e=d(),t=p();if((e||t)&&!s.searchParams.get("complete")){s.searchParams.set("complete","1");const{href:n,origin:r}=s;return e&&parent.postMessage({type:"completeAuth",url:n},r),t&&(opener.postMessage({type:"completeAuth",url:n},r),window.close()),new Promise(()=>{})}}s.searchParams.delete("complete"),r.assert(g,"No state found! Please (re)launch the app.");if(!(!u||(null===(t=g.tokenResponse)||void 0===t?void 0:t.access_token))&&g.tokenUri){r.assert(u,"'code' url parameter is required");const t=await async function(e,t,n){r.assert(t,"'code' parameter is required"),r.assert(n,"'state' parameter is required");const s=e.getStorage();let o=await s.get(n);i("Preparing to exchange the code for access token...");const a=w(t,o);i("Token request options: %O",a),r.assert(o.tokenUri,"No tokenUri found for this server");const c=await r.request(o.tokenUri,a);return i("Token response: %O",c),r.assert(c.access_token,"Failed to obtain access token."),c}(e,u,f);g.expiresAt=r.getAccessTokenExpiration(t),g={...g,tokenResponse:t},await a.set(f,g),i("Authorization successful!")}else i((null===(n=g.tokenResponse)||void 0===n?void 0:n.access_token)?"Already authorized":"No authorization needed");return await async function(e){const t=e.getUrl(),n=e.getStorage(),s=t.searchParams,a=s.get("code"),c=s.get("state");if(t.href,a&&(s.delete("code"),i("Removed code parameter from the url.")),c){(await n.get(c)).multiple||(await n.set(o.SMART_KEY,c),s.delete("state"),i("Removed state parameter from the url."))}if(!r.isBrowser()||!window.history.replaceState)return e.redirect(t.href);window.history.replaceState({},"",t.href)}(e),y(e,f)}function w(e,t){const{redirectUri:n,clientSecret:s,tokenUri:o,clientId:a}=t;r.assert(n,"Missing state.redirectUri"),r.assert(o,"Missing state.tokenUri"),r.assert(a,"Missing state.clientId");const c={method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:`code=${e}&grant_type=authorization_code&redirect_uri=${encodeURIComponent(n)}`};return s?(c.headers.authorization="Basic "+r.btoa(a+":"+s),i("Using state.clientSecret to construct the authorization header: %s",c.headers.Authorization)):(i("No clientSecret found in state. Adding the clientId to the POST body"),c.body+="&client_id="+encodeURIComponent(a)),c}async function y(e,t){const n=e.getStorage(),o=await n.get(t);return r.assert(o,"No state found in storage. Please (re)launch the SMART app"),new s.Client(o,{save:e=>n.set(t,e)})}t.fetchWellKnownJson=a,t.getSecurityExtensions=h,t.authorize=f,t.isInFrame=d,t.isInPopUp=p,t.onMessage=g,t.completeAuth=m,t.buildTokenRequest=w,t.getClient=y,t.ready=async function(e,t,n){let r;const s=e.getUrl().searchParams,i=s.get("code"),a=s.get("state");if(i)r=m(e);else if(a)r=y(e,a);else{const t=await e.getStorage().get(o.SMART_KEY);r=y(e,t)}return t&&(r=r.then(t)),n&&(r=r.catch(n)),r},t.init=async function(e,t){const n=e.getUrl(),r=n.searchParams.get("code"),i=n.searchParams.get("state");if(r&&i)return m(e);const a=e.getStorage(),c=i||await a.get(o.SMART_KEY),u=await a.get(c);return u?new s.Client(u,{save:e=>a.set(c,e)}):f(e,t).then(()=>new Promise(()=>{}))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(13);t.default=class{constructor(e={}){this._url=null,this._storage=null,this.options={replaceBrowserHistory:!0,refreshTokenWithCredentials:"same-origin",...e}}relative(e){return new URL(e,this.getUrl().href).href}get fhir(){return"function"==typeof fhir?fhir:null}getUrl(){return this._url||(this._url=new URL(location+"")),this._url}redirect(e){location.href=e}getStorage(){return this._storage||(this._storage=new r.default),this._storage}getAbortController(){return AbortController}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{async get(e){const t=sessionStorage[e];if(t)return JSON.parse(t)}async set(e,t){return sessionStorage[e]=JSON.stringify(t),t}async unset(e){return e in sessionStorage&&(delete sessionStorage[e],!0)}async clear(){return sessionStorage.clear()}async save(e){for(const t of Object.keys(e))await this.set(t,e[t]);return e}}}]);
//# sourceMappingURL=fhir-client.pure.min.js.map